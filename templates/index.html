<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè¯­è¨€æ™ºèƒ½å®¢æœ</title>
    <!-- Fallback to Cloudflare CDN for Tailwind CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: calc(100vh - 280px);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .message {
            animation: slideInUp 0.4s ease-out;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            display: none;
        }
        .typing-indicator.show {
            display: flex;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9CA3AF;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .message-bubble {
            position: relative;
            border-radius: 18px;
            padding: 12px 16px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message-bubble::before {
            content: '';
            position: absolute;
            bottom: 0;
            width: 20px;
            height: 20px;
        }
        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }
        .user-message::before {
            right: -10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 0 0 20px;
        }
        .ai-message {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .ai-message::before {
            left: -10px;
            background: white;
            border-radius: 0 0 20px 0;
        }
        .quick-question {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .quick-question:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .scroll-to-bottom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .scroll-to-bottom:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .conversation-context {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
            border-left: 3px solid #667eea;
        }

        /* æ·±è‰²ä¸»é¢˜æ ·å¼ */
        .dark {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .dark .chat-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        .dark .bg-white {
            background-color: #1e293b;
        }

        .dark .text-gray-700 {
            color: #e2e8f0;
        }

        .dark .text-gray-600 {
            color: #cbd5e1;
        }

        .dark .text-gray-500 {
            color: #94a3b8;
        }

        .dark .border-gray-100 {
            border-color: #334155;
        }

        .dark .border-gray-200 {
            border-color: #475569;
        }

        .dark .border-gray-300 {
            border-color: #64748b;
        }

        .dark .ai-message {
            background: #334155;
            color: #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .dark .ai-message::before {
            background: #334155;
        }

        .dark .conversation-context {
            background: rgba(51, 65, 85, 0.9);
            color: #cbd5e1;
        }

        .dark .bg-gray-50 {
            background-color: #1e293b;
        }

        .dark .bg-gray-100 {
            background-color: #334155;
        }

        .dark .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .dark .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .dark .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        }

        .dark .hover\:border-blue-300:hover {
            border-color: #60a5fa;
        }

        .dark .hover\:shadow-lg:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        .dark .focus\:ring-blue-500:focus {
            --tw-ring-color: #3b82f6;
        }

        .dark .focus\:border-transparent:focus {
            border-color: transparent;
        }

        .dark .border-gray-300 {
            border-color: #64748b;
        }

        .dark .text-gray-400 {
            color: #94a3b8;
        }

        .dark .text-red-500 {
            color: #ef4444;
        }

        .dark .text-red-700 {
            color: #b91c1c;
        }

        .dark .text-green-500 {
            color: #10b981;
        }

        .dark .text-blue-500 {
            color: #3b82f6;
        }

        .dark .text-purple-500 {
            color: #8b5cf6;
        }

        .dark .text-green-400 {
            color: #34d399;
        }

        .dark .text-emerald-400 {
            color: #6ee7b7;
        }

        .dark .text-orange-400 {
            color: #fb923c;
        }

        .dark .text-red-400 {
            color: #f87171;
        }

        .dark .text-pink-400 {
            color: #f472b6;
        }

        .dark .text-cyan-400 {
            color: #22d3ee;
        }

        .dark .text-yellow-500 {
            color: #eab308;
        }

        .dark .bg-gradient-to-br {
            background: linear-gradient(to bottom right, #1a1a2e, #16213e);
        }

        .dark .from-blue-50 {
            --tw-gradient-from: #1a1a2e;
            --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(26, 26, 46, 0));
        }

        .dark .to-purple-50 {
            --tw-gradient-to: #16213e;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <div class="min-h-screen">
        <!-- å¤´éƒ¨ -->
        <header class="gradient-bg text-white shadow-xl">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-2xl"></i>
                        </div>
                        <div>
                            <h1 id="headerTitle" class="text-2xl font-bold">å¤šè¯­è¨€æ™ºèƒ½å®¢æœ</h1>
                            <p id="headerSubtitle" class="text-sm opacity-90">AIé©±åŠ¨çš„é—®ç­”åŠ©æ‰‹</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2 bg-white bg-opacity-20 rounded-full px-4 py-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span id="onlineStatusText" class="text-sm"></span>
                        </div>
                        <button onclick="toggleTheme()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all">
                            <i class="fas fa-moon"></i>
                        </button>
                        <button onclick="showSettingsModal()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all" title="è®¾ç½®">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-5xl mx-auto">
                <!-- èŠå¤©åŒºåŸŸ -->
                <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-gray-100">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="gradient-bg text-white px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-headset text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">æ™ºèƒ½å®¢æœåŠ©æ‰‹</h3>
                                    <p class="text-sm opacity-90">ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å’¨è¯¢æœåŠ¡</p>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <div class="relative">
                                    <button id="languageButton" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all" title="é€‰æ‹©è¯­è¨€">
                                        <i class="fas fa-globe"></i>
                                    </button>
                                    <div id="languageDropdown" class="absolute right-0 mt-2 w-32 bg-white rounded-md shadow-lg py-1 hidden z-50">
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="zh">ä¸­æ–‡</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="en">English</a>
                                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-lang="hi">à¤¹à¤¿à¤‚à¤¦à¥€</a>
                                    </div>
                                </div>
                                <button id="exportChatButton" onclick="exportChat()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all" title="å¯¼å‡ºèŠå¤©è®°å½•">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button id="clearChatButton" onclick="clearChat()" class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all" title="æ¸…ç©ºèŠå¤©">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
                    <div id="chatMessages" class="chat-container overflow-y-auto p-6 space-y-4">
                        <div id="welcomeMessage"></div>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="border-t border-gray-100 bg-gray-50 p-6">
                        <form id="chatForm" class="space-y-4">
                            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                            <div id="imageUploadArea" class="hidden">
                                <div class="bg-white rounded-lg border-2 border-dashed border-gray-300 p-4 text-center">
                                    <div class="flex items-center justify-center space-x-2">
                                        <i class="fas fa-image text-gray-400 text-xl"></i>
                                        <span class="text-gray-600">å·²é€‰æ‹©å›¾ç‰‡</span>
                                    </div>
                                    <div id="imagePreview" class="mt-3">
                                        <img id="previewImg" class="max-h-32 mx-auto rounded-lg shadow-md" alt="é¢„è§ˆå›¾ç‰‡">
                                    </div>
                                    <button type="button" onclick="removeImage()" class="mt-2 text-red-500 hover:text-red-700 text-sm">
                                        <i class="fas fa-times mr-1"></i>ç§»é™¤å›¾ç‰‡
                                    </button>
                                </div>
                            </div>

                            <!-- è¾“å…¥æ¡†å’ŒæŒ‰é’® -->
                            <div class="flex space-x-3">
                                <!-- å›¾ç‰‡ä¸Šä¼ æŒ‰é’® -->
                                <div class="relative">
                                    <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="previewImage()">
                                    <button type="button" onclick="document.getElementById('imageInput').click()"
                                            class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-xl flex items-center justify-center transition-all transform hover:scale-105 shadow-lg">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>

                                <!-- æ–‡æœ¬è¾“å…¥ -->
                                <div class="flex-1 relative">
                                    <textarea id="messageInput"
                                              placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®©æˆ‘å¸®æ‚¨åˆ†æ..."
                                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none shadow-sm"
                                              rows="1"
                                              onkeydown="handleKeyDown(event)"></textarea>
                                    <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                                        <span id="charCount">0</span>/500
                                    </div>
                                </div>

                                <!-- å‘é€æŒ‰é’® -->
                                <button type="submit"
                                        class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-xl flex items-center justify-center transition-all transform hover:scale-105 shadow-lg">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>

                            <!-- è¾“å…¥æç¤º -->
                            <div class="flex items-center justify-between text-xs text-gray-500">
                                <div class="flex items-center space-x-4">
                                    <span><i class="fas fa-lightbulb mr-1"></i>æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡è¾“å…¥</span>
                                    <span><i class="fas fa-brain mr-1"></i>AIæ™ºèƒ½åˆ†æ</span>
                                    <span><i class="fas fa-history mr-1"></i>å¯¹è¯è®°å¿†</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span id="conversationCount">å¯¹è¯è½®æ¬¡: 0</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- å¿«é€Ÿé—®é¢˜ -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                        å¸¸è§é—®é¢˜
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button onclick="askQuestion('refund_request')"
                                class="quick-question bg-white p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all text-left group">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-red-400 to-pink-400 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-undo text-white"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">é€€æ¬¾ç”³è¯·</p>
                                    <p class="text-xs text-gray-500">å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="askQuestion('delivery_time')"
                                class="quick-question bg-white p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all text-left group">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-cyan-400 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-shipping-fast text-white"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">å‘è´§æ—¶é—´</p>
                                    <p class="text-xs text-gray-500">å•†å“ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="askQuestion('logistics_query')"
                                class="quick-question bg-white p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all text-left group">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-emerald-400 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-truck text-white"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">ç‰©æµæŸ¥è¯¢</p>
                                    <p class="text-xs text-gray-500">å¦‚ä½•æŸ¥çœ‹ç‰©æµä¿¡æ¯ï¼Ÿ</p>
                                </div>
                            </div>
                        </button>
                        <button onclick="askQuestion('quality_issue')"
                                class="quick-question bg-white p-4 rounded-xl border border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all text-left group">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-r from-orange-400 to-red-400 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="fas fa-exclamation-triangle text-white"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">è´¨é‡é—®é¢˜</p>
                                    <p class="text-xs text-gray-500">å•†å“æœ‰è´¨é‡é—®é¢˜æ€ä¹ˆåŠï¼Ÿ</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="gradient-bg text-white px-6 py-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold" id="apiSettingsTitle">APIè®¾ç½®</h3>
                    <button onclick="hideSettingsModal()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1" id="apiKeyLabel">API Key</label>
                        <input type="password" id="apiKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-placeholder="apiKeyPlaceholder">
                    </div>
                    <div>
                        <label for="apiEndpointInput" class="block text-sm font-medium text-gray-700 mb-1" id="apiEndpointLabel">APIåœ°å€</label>
                        <input type="text" id="apiEndpointInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" data-placeholder="apiEndpointPlaceholder">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="hideSettingsModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50" id="apiCancelButton">å–æ¶ˆ</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600" id="apiSaveButton">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ®åŠ¨æŒ‰é’® -->
    <div class="floating-action">
        <button onclick="scrollToBottom()" class="scroll-to-bottom" title="æ»šåŠ¨åˆ°åº•éƒ¨">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentLanguage = 'zh'; // é»˜è®¤ä¸­æ–‡

        // è®¾ç½®å¼¹çª—åŠŸèƒ½
        function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;

            modal.classList.remove('hidden');

            // è·å–è¾“å…¥å…ƒç´ 
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiEndpointInput = document.getElementById('apiEndpointInput');

            // å®‰å…¨è®¾ç½®å€¼
            if (apiKeyInput) {
                apiKeyInput.value = localStorage.getItem('apiKeyInput') || '';
            }
            if (apiEndpointInput) {
                apiEndpointInput.value = localStorage.getItem('apiEndpointInput') || '';
            }

        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value;
            const apiUrl = document.getElementById('apiEndpointInput').value;

            // å‘é€åˆ°åç«¯
            fetch('/api/update-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    apiKey: apiKey,
                    apiUrl: apiUrl
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
                return response.json();
            })
            .then(data => {
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('apiKeyInput', apiKey);
                localStorage.setItem('apiEndpointInput', apiUrl);

                hideSettingsModal();
                alert(translations[currentLanguage].settingsSaved);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(translations[currentLanguage].settingsSaveFailed + error.message);
            });
            console.log('è®¾ç½®å·²ä¿å­˜', {apiKey, apiUrl});
        }

        // ç¿»è¯‘å­—å…¸
        const translations = {
            zh: {
                app_title: "å¤šè¯­è¨€æ™ºèƒ½å®¢æœ",
                app_subtitle: "AIé©±åŠ¨çš„é—®ç­”åŠ©æ‰‹",
                chat_title: "æ™ºèƒ½å®¢æœåŠ©æ‰‹",
                online_status: "åœ¨çº¿æœåŠ¡",
                chat_subtitle: "ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å’¨è¯¢æœåŠ¡",
                export_title: "å¯¼å‡ºèŠå¤©è®°å½•",
                clear_title: "æ¸…ç©ºèŠå¤©",
                input_placeholder: "è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®©æˆ‘å¸®æ‚¨åˆ†æ...",
                hint_text: "æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡è¾“å…¥",
                hint_ai: "AIæ™ºèƒ½åˆ†æ",
                hint_history: "å¯¹è¯è®°å¿†",
                conversation_count: "å¯¹è¯è½®æ¬¡: ",
                quick_questions: "å¸¸è§é—®é¢˜",
                refund_request: "é€€æ¬¾ç”³è¯·",
                refund_request_question: "å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ",
                delivery_time: "å‘è´§æ—¶é—´",
                delivery_time_question: "å•†å“ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ",
                logistics_query: "ç‰©æµæŸ¥è¯¢",
                logistics_query_question: "å¦‚ä½•æŸ¥çœ‹ç‰©æµä¿¡æ¯ï¼Ÿ",
                quality_issue: "è´¨é‡é—®é¢˜",
                quality_issue_question: "å•†å“æœ‰è´¨é‡é—®é¢˜æ€ä¹ˆåŠï¼Ÿ",
                welcome_title: "ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±ä¼ä¸šé—®ç­”åŠ©æ‰‹",
                api_key_label: "APIå¯†é’¥",
                api_endpoint_label: "APIç«¯ç‚¹",
                api_key_placeholder: "è¾“å…¥æ‚¨çš„APIå¯†é’¥",
                api_endpoint_placeholder: "è¾“å…¥APIç«¯ç‚¹URL",
                cancel_button: "å–æ¶ˆ",
                save_button: "ä¿å­˜è®¾ç½®",
                api_settings_title: "APIè®¾ç½®",
                api_settings_description: "é…ç½®APIè¿æ¥å‚æ•°",
                settings_saved: "è®¾ç½®å·²ä¿å­˜å¹¶æ›´æ–°åˆ°æœåŠ¡å™¨",
                settings_save_failed: "ä¿å­˜å¤±è´¥: ",
                welcome_description: "æˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å…¨æ–¹ä½çš„å’¨è¯¢æœåŠ¡ï¼š",
                service1: "æ¸¸æˆæ´»åŠ¨ä»‹ç»",
                service2: "å›¾ç‰‡åˆ†æä¸è¯†åˆ«",
                service3: "æ¸¸æˆè§„åˆ™æŸ¥è¯¢",
                service4: "å”®åé—®é¢˜å¤„ç†",
                welcome_footer: "è¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Œæˆ‘ä¼šè®°ä½æˆ‘ä»¬çš„å¯¹è¯å†…å®¹ï¼Œä¸ºæ‚¨æä¾›è¿è´¯çš„æœåŠ¡ï¼",
                language_switched: "å·²åˆ‡æ¢è‡³ {0}",
                clear_confirm: "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ",
                clear_success: "å¯¹è¯å†å²å·²æ¸…ç©º",
                clear_fail: "æ¸…ç©ºå¯¹è¯å†å²å¤±è´¥ï¼Œè¯·é‡è¯•",
                no_export: "æš‚æ— èŠå¤©è®°å½•å¯å¯¼å‡º",
                user_role: "ç”¨æˆ·",
                assistant_role: "åŠ©æ‰‹",
                conversation_start: "å¯¹è¯å¼€å§‹",
                assistant_reply: "åŠ©æ‰‹å›å¤",
            },
            en: {
                app_title: "Enterprise AI Customer Service",
                app_subtitle: "AI-powered Q&A Assistant",
                chat_title: "Smart Customer Service Assistant",
                online_status: "Online Service",
                conversation_start: "Conversation Start",
                assistant_reply: "Assistant Reply",
                api_settings_title: "API Settings",
                api_settings_description: "Configure API connection parameters",
                api_key_label: "API Key",
                settings_modal_title: "API Settings",
                settings_saved: "Settings saved successfully",
                settings_save_failed: "Failed to save settings: ",
                api_endpoint_label: "API Endpoint",
                api_key_placeholder: "Enter API Key",
                api_endpoint_placeholder: "Enter API Endpoint",
                cancel_button: "Cancel",
                save_button: "Save Settings",
                chat_subtitle: "Professional consulting services for you",
                export_title: "Export Chat",
                clear_title: "Clear Chat",
                input_placeholder: "Please enter your question, or upload an image for analysis...",
                hint_text: "Supports text and image input",
                hint_ai: "AI Intelligent Analysis",
                hint_history: "Conversation History",
                conversation_count: "Conversation Count: ",
                quick_questions: "Frequently Asked Questions",
                refund_request: "Refund Request",
                refund_request_question: "How to request a refund?",
                delivery_time: "Delivery Time",
                delivery_time_question: "When will the goods be shipped?",
                logistics_query: "Logistics Query",
                logistics_query_question: "How to track logistics information?",
                quality_issue: "Quality Issue",
                quality_issue_question: "What to do with quality problems?",
                welcome_title: "ğŸ‘‹ Hello! I am your enterprise Q&A assistant",
                welcome_description: "I can provide you with comprehensive consulting services:",
                service1: "Game event introduction",
                service2: "Image analysis and recognition",
                service3: "Game rule query",
                service4: "After-sales problem handling",
                welcome_footer: "Please tell me what you need help with, and I will remember our conversation to provide you with consistent service!",
                language_switched: "Switched to {0}",
                clear_confirm: "Are you sure you want to clear all chat history?",
                clear_success: "Conversation history cleared",
                clear_fail: "Failed to clear conversation history, please try again",
                no_export: "No chat history to export",
                user_role: "User",
                assistant_role: "Assistant"
            },
            hi: {
                app_title: "à¤à¤‚à¤Ÿà¤°à¤ªà¥à¤°à¤¾à¤‡à¤œ à¤—à¥à¤°à¤¾à¤¹à¤• à¤¸à¥‡à¤µà¤¾",
                app_subtitle: "AI-à¤¸à¤‚à¤šà¤¾à¤²à¤¿à¤¤ à¤ªà¥à¤°à¤¶à¥à¤¨à¥‹à¤¤à¥à¤¤à¤° à¤¸à¤¹à¤¾à¤¯à¤•",
                chat_title: "à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿ à¤—à¥à¤°à¤¾à¤¹à¤• à¤¸à¥‡à¤µà¤¾ à¤¸à¤¹à¤¾à¤¯à¤•",
                online_status: "à¤‘à¤¨à¤²à¤¾à¤‡à¤¨ à¤¸à¥‡à¤µà¤¾",
                conversation_start: "à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤¶à¥à¤°à¥‚",
                assistant_reply: "à¤¸à¤¹à¤¾à¤¯à¤• à¤‰à¤¤à¥à¤¤à¤°",
                api_settings_title: "à¤à¤ªà¥€à¤†à¤ˆ à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸",
                api_settings_description: "à¤à¤ªà¥€à¤†à¤ˆ à¤•à¤¨à¥‡à¤•à¥à¤¶à¤¨ à¤ªà¥ˆà¤°à¤¾à¤®à¥€à¤Ÿà¤° à¤•à¥‰à¤¨à¥à¤«à¤¼à¤¿à¤—à¤° à¤•à¤°à¥‡à¤‚",
                api_key_label: "à¤à¤ªà¥€à¤†à¤ˆ à¤•à¥à¤‚à¤œà¥€",
                api_endpoint_label: "à¤à¤ªà¥€à¤†à¤ˆ à¤à¤‚à¤¡à¤ªà¥‰à¤‡à¤‚à¤Ÿ",
                api_key_placeholder: "à¤à¤ªà¥€à¤†à¤ˆ à¤•à¥à¤‚à¤œà¥€ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚",
                api_endpoint_placeholder: "à¤à¤ªà¥€à¤†à¤ˆ à¤à¤‚à¤¡à¤ªà¥‰à¤‡à¤‚à¤Ÿ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚",
                cancel_button: "à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚",
                save_button: "à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸ à¤¸à¤¹à¥‡à¤œà¥‡à¤‚",
                chat_subtitle: "à¤†à¤ªà¤•à¥‡ à¤²à¤¿à¤ à¤ªà¥‡à¤¶à¥‡à¤µà¤° à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤¸à¥‡à¤µà¤¾à¤à¤‚",
                export_title: "à¤šà¥ˆà¤Ÿ à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¥‡à¤‚",
                clear_title: "à¤šà¥ˆà¤Ÿ à¤¸à¤¾à¤«à¤¼ à¤•à¤°à¥‡à¤‚",
                input_placeholder: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤…à¤ªà¤¨à¤¾ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚, à¤¯à¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤à¤• à¤›à¤µà¤¿ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚...",
                hint_text: "à¤ªà¤¾à¤  à¤”à¤° à¤›à¤µà¤¿ à¤‡à¤¨à¤ªà¥à¤Ÿ à¤•à¤¾ à¤¸à¤®à¤°à¥à¤¥à¤¨ à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆ",
                hint_ai: "à¤à¤†à¤ˆ à¤¬à¥à¤¦à¥à¤§à¤¿à¤®à¤¾à¤¨ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£",
                hint_history: "à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸",
                conversation_count: "à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤¸à¤‚à¤–à¥à¤¯à¤¾: ",
                quick_questions: "à¤¸à¤¾à¤®à¤¾à¤¨à¥à¤¯ à¤ªà¥à¤°à¤¶à¥à¤¨",
                refund_request: "à¤§à¤¨à¤µà¤¾à¤ªà¤¸à¥€ à¤…à¤¨à¥à¤°à¥‹à¤§",
                refund_request_question: "à¤§à¤¨à¤µà¤¾à¤ªà¤¸à¥€ à¤…à¤¨à¥à¤°à¥‹à¤§ à¤•à¥ˆà¤¸à¥‡ à¤•à¤°à¥‡à¤‚?",
                delivery_time: "à¤¶à¤¿à¤ªà¤¿à¤‚à¤— à¤¸à¤®à¤¯",
                delivery_time_question: "à¤®à¤¾à¤² à¤•à¤¬ à¤­à¥‡à¤œà¤¾ à¤œà¤¾à¤à¤—à¤¾?",
                logistics_query: "à¤²à¥‰à¤œà¤¿à¤¸à¥à¤Ÿà¤¿à¤•à¥à¤¸ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€",
                logistics_query_question: "à¤²à¥‰à¤œà¤¿à¤¸à¥à¤Ÿà¤¿à¤•à¥à¤¸ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤•à¥ˆà¤¸à¥‡ à¤¦à¥‡à¤–à¥‡à¤‚?",
                quality_issue: "à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤¸à¤®à¤¸à¥à¤¯à¤¾",
                quality_issue_question: "à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤¸à¤®à¤¸à¥à¤¯à¤¾à¤“à¤‚ à¤•à¤¾ à¤•à¥à¤¯à¤¾ à¤•à¤°à¥‡à¤‚?",
                welcome_title: "ğŸ‘‹ à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¤¾ à¤‰à¤¦à¥à¤¯à¤® à¤ªà¥à¤°à¤¶à¥à¤¨à¥‹à¤¤à¥à¤¤à¤° à¤¸à¤¹à¤¾à¤¯à¤• à¤¹à¥‚à¤‚",
                welcome_description: "à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥‹ à¤µà¥à¤¯à¤¾à¤ªà¤• à¤ªà¤°à¤¾à¤®à¤°à¥à¤¶ à¤¸à¥‡à¤µà¤¾à¤à¤‚ à¤ªà¥à¤°à¤¦à¤¾à¤¨ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤‚:",
                service1: "à¤—à¥‡à¤® à¤‡à¤µà¥‡à¤‚à¤Ÿ à¤ªà¤°à¤¿à¤šà¤¯",
                service2: "à¤›à¤µà¤¿ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤”à¤° à¤ªà¤¹à¤šà¤¾à¤¨",
                service3: "à¤—à¥‡à¤® à¤¨à¤¿à¤¯à¤® à¤ªà¥à¤°à¤¶à¥à¤¨",
                service4: "à¤¬à¤¿à¤•à¥à¤°à¥€ à¤•à¥‡ à¤¬à¤¾à¤¦ à¤¸à¤®à¤¸à¥à¤¯à¤¾ à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨",
                welcome_footer: "à¤•à¥ƒà¤ªà¤¯à¤¾ à¤®à¥à¤à¥‡ à¤¬à¤¤à¤¾à¤à¤‚ à¤•à¤¿ à¤†à¤ªà¤•à¥‹ à¤•à¤¿à¤¸ à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾ à¤•à¥€ à¤†à¤µà¤¶à¥à¤¯à¤•à¤¤à¤¾ à¤¹à¥ˆ, à¤”à¤° à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥‹ à¤¸à¥à¤¸à¤‚à¤—à¤¤ à¤¸à¥‡à¤µà¤¾ à¤ªà¥à¤°à¤¦à¤¾à¤¨ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤¹à¤®à¤¾à¤°à¥€ à¤¬à¤¾à¤¤à¤šà¥€à¤¤ à¤•à¥‹ à¤¯à¤¾à¤¦ à¤°à¤–à¥‚à¤‚à¤—à¤¾!",
                language_switched: "{0} à¤ªà¤° à¤¸à¥à¤µà¤¿à¤š à¤•à¤¿à¤¯à¤¾ à¤—à¤¯à¤¾",
                clear_confirm: "à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤µà¤¾à¤•à¤ˆ à¤¸à¤­à¥€ à¤šà¥ˆà¤Ÿ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¸à¤¾à¤«à¤¼ à¤•à¤°à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?",
                clear_success: "à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¸à¤¾à¤«à¤¼ à¤¹à¥‹ à¤—à¤¯à¤¾",
                clear_fail: "à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¸à¤¾à¤«à¤¼ à¤•à¤°à¤¨à¥‡ à¤®à¥‡à¤‚ à¤µà¤¿à¤«à¤², à¤•à¥ƒà¤ªà¤¯à¤¾ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚",
                no_export: "à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤ à¤•à¤°à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤•à¥‹à¤ˆ à¤šà¥ˆà¤Ÿ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸ à¤¨à¤¹à¥€à¤‚",
                user_role: "à¤‰à¤ªà¤¯à¥‹à¤—à¤•à¤°à¥à¤¤à¤¾",
                assistant_role: "à¤¸à¤¹à¤¾à¤¯à¤•"
            }
        };

        // è·å–å½“å‰é€‰ä¸­çš„è¯­è¨€
        function getCurrentLanguage() {
            return localStorage.getItem('selectedLanguage') || 'zh';
        }

        // æ›´æ–°UIæ–‡æœ¬ (ä¸ä¿®æ”¹èŠå¤©æ¶ˆæ¯)
        function updateUIText(lang) {
            const langData = translations[lang] || translations['zh'];

            // å®‰å…¨æ›´æ–°åº”ç”¨æ ‡é¢˜
            document.querySelector('title').textContent = langData.app_title || "å¤šè¯­è¨€æ™ºèƒ½å®¢æœ";
            document.getElementById('headerTitle').textContent = langData.app_title || "å¤šè¯­è¨€æ™ºèƒ½å®¢æœ";
            document.getElementById('headerSubtitle').textContent = langData.app_subtitle || "AIé©±åŠ¨çš„é—®ç­”åŠ©æ‰‹";
            document.getElementById('onlineStatusText').textContent = langData.online_status || "åœ¨çº¿æœåŠ¡";

            // å®‰å…¨æ›´æ–°èŠå¤©å¤´éƒ¨
            const chatTitle = document.querySelector('h3.font-bold');
            const chatSubtitle = document.querySelector('.gradient-bg h3 + p');
            if (chatTitle) chatTitle.textContent = langData.chat_title || "æ™ºèƒ½å®¢æœåŠ©æ‰‹";
            if (chatSubtitle) chatSubtitle.textContent = langData.chat_subtitle || "ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„å’¨è¯¢æœåŠ¡";

            // å®‰å…¨æ›´æ–°æŒ‰é’®æ ‡é¢˜ (ä½¿ç”¨å»¶è¿Ÿé€‰æ‹©)
            setTimeout(() => {
                const exportButton = document.getElementById('exportChatButton');
                const clearButton = document.getElementById('clearChatButton');
                if (exportButton) exportButton.title = langData.export_title || 'å¯¼å‡ºèŠå¤©è®°å½•';
                if (clearButton) clearButton.title = langData.clear_title || 'æ¸…ç©ºèŠå¤©';
            }, 0);

            // å®‰å…¨æ›´æ–°è¾“å…¥åŒºåŸŸ
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.placeholder = langData.input_placeholder || "è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ–ä¸Šä¼ å›¾ç‰‡è®©æˆ‘å¸®æ‚¨åˆ†æ...";
            }

            // å®‰å…¨æ›´æ–°æç¤ºæ–‡æœ¬
            const hints = document.querySelectorAll('.text-xs.text-gray-500 span');
            if (hints.length > 0) hints[0].textContent = langData.hint_text || "æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡è¾“å…¥";
            if (hints.length > 1) hints[1].textContent = langData.hint_ai || "AIæ™ºèƒ½åˆ†æ";
            if (hints.length > 2) hints[2].textContent = langData.hint_history || "å¯¹è¯è®°å¿†";

            // å®‰å…¨æ›´æ–°å¯¹è¯è®¡æ•°å‰ç¼€
            const countSpan = document.getElementById('conversationCount');
            if (countSpan) {
                const count = countSpan.textContent.replace(/[^0-9]/g, '');
                countSpan.textContent = (langData.conversation_count || "å¯¹è¯è½®æ¬¡: ") + (count || '0');
            }

            // å®‰å…¨æ›´æ–°å¸¸è§é—®é¢˜æ ‡é¢˜
            const quickTitle = document.querySelector('.mt-8 h3');
            if (quickTitle) quickTitle.textContent = langData.quick_questions || "å¸¸è§é—®é¢˜";

            // å®‰å…¨æ›´æ–°å¿«é€Ÿé—®é¢˜æŒ‰é’®
            const buttons = document.querySelectorAll('.quick-question');
            if (buttons.length > 0) {
                buttons[0].querySelector('p.font-medium').textContent = langData.refund_request || "é€€æ¬¾ç”³è¯·";
                buttons[0].querySelector('p.text-xs').textContent = langData.refund_request_question || "å¦‚ä½•ç”³è¯·é€€æ¬¾ï¼Ÿ";

                buttons[1].querySelector('p.font-medium').textContent = langData.delivery_time || "å‘è´§æ—¶é—´";
                buttons[1].querySelector('p.text-xs').textContent = langData.delivery_time_question || "å•†å“ä»€ä¹ˆæ—¶å€™å‘è´§ï¼Ÿ";

                buttons[2].querySelector('p.font-medium').textContent = langData.logistics_query || "ç‰©æµæŸ¥è¯¢";
                buttons[2].querySelector('p.text-xs').textContent = langData.logistics_query_question || "å¦‚ä½•æŸ¥çœ‹ç‰©æµä¿¡æ¯ï¼Ÿ";

                buttons[3].querySelector('p.font-medium').textContent = langData.quality_issue || "è´¨é‡é—®é¢˜";
                buttons[3].querySelector('p.text-xs').textContent = langData.quality_issue_question || "å•†å“æœ‰è´¨é‡é—®é¢˜æ€ä¹ˆåŠï¼Ÿ";
            }
        }

        let selectedImage = null;
        let conversationHistory = [];
        let conversationCount = 0;

        // è¯­è¨€åˆ‡æ¢åŠŸèƒ½
        const languageButton = document.getElementById('languageButton');
        const languageDropdown = document.getElementById('languageDropdown');

        if (languageButton && languageDropdown) {
            languageButton.addEventListener('click', function(e) {
                e.stopPropagation();
                languageDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', function() {
                languageDropdown.classList.add('hidden');
            });

            languageDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                if (e.target.tagName === 'A') {
                    const lang = e.target.getAttribute('data-lang');
                    setLanguage(lang);
                    languageDropdown.classList.add('hidden');

                    // æ›´æ–°æŒ‰é’®å›¾æ ‡
                    if (lang === 'zh') languageButton.innerHTML = '<i class="fas fa-globe"></i>';
                    if (lang === 'en') languageButton.innerHTML = '<i class="fas fa-language"></i>';
                    if (lang === 'hi') languageButton.innerHTML = '<i class="fas fa-font"></i>';
                }
            });
        }

        // ç¿»è¯‘ä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼ˆä½¿ç”¨æ•°æ®å±æ€§ï¼‰
        function translateMessages(lang) {
            const langData = translations[lang] || translations['zh'];
            const contextElements = document.querySelectorAll('.conversation-context');

            contextElements.forEach(element => {
                const contextKey = element.dataset.contextKey;
                if (contextKey) {
                    element.textContent = langData[contextKey] ||
                        translations['zh'][contextKey] ||
                        (contextKey === 'conversation_start' ? 'å¯¹è¯å¼€å§‹' : 'åŠ©æ‰‹å›å¤');
                }
            });
        }

        function setLanguage(lang) {
            localStorage.setItem('selectedLanguage', lang);
            const langData = translations[lang] || translations['zh'];

            // Safely handle notification with fallback
            const notificationText = langData.language_switched
                ? langData.language_switched.replace('{0}', getLanguageName(lang))
                : `å·²åˆ‡æ¢è‡³ ${getLanguageName(lang)}`;

            showNotification(notificationText, 'info');

            // æ›´æ–°UIæ–‡æœ¬ï¼ˆä¸ä¿®æ”¹èŠå¤©æ¶ˆæ¯ï¼‰
            updateUIText(lang);
            // æ›´æ–°å¼¹å‡ºæ¡†è¯­è¨€
            console.log('å½“å‰è¯­è¨€:', lang);
            console.log('ç¿»è¯‘æ•°æ®:', translations[lang]);

            // æ›´æ–°APIè®¾ç½®æ–‡æœ¬
            const apiTitle = document.getElementById('apiSettingsTitle');
            const apiDesc = document.getElementById('apiSettingsDescription');
            const apiKeyLabel = document.getElementById('apiKeyLabel');
            const apiEndpointLabel = document.getElementById('apiEndpointLabel');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiEndpointInput = document.getElementById('apiEndpointInput');
            const cancelButton = document.getElementById('apiCancelButton');
            const saveButton = document.getElementById('apiSaveButton');

            if (apiTitle) apiTitle.textContent = langData.api_settings_title || "APIè®¾ç½®";
            if (apiDesc) apiDesc.textContent = langData.api_settings_description || "é…ç½®APIè¿æ¥å‚æ•°";
            if (apiKeyLabel) apiKeyLabel.textContent = langData.api_key_label || "APIå¯†é’¥";
            if (apiEndpointLabel) apiEndpointLabel.textContent = langData.api_endpoint_label || "APIç«¯ç‚¹";
            if (cancelButton) cancelButton.textContent = langData.cancel_button || "å–æ¶ˆ";
            if (saveButton) saveButton.textContent = langData.save_button || "ä¿å­˜è®¾ç½®";
            if (apiKeyInput) apiKeyInput.placeholder = langData.api_key_placeholder ||
                                  (lang === 'en' ? "Enter API Key" :
                                   lang === 'hi' ? "à¤à¤ªà¥€à¤†à¤ˆ à¤•à¥à¤‚à¤œà¥€ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚" : "è¯·è¾“å…¥APIå¯†é’¥");
            if (apiEndpointInput) apiEndpointInput.placeholder = langData.api_endpoint_placeholder ||
                                     (lang === 'en' ? "Enter API Endpoint" :
                                      lang === 'hi' ? "à¤à¤ªà¥€à¤†à¤ˆ à¤à¤‚à¤¡à¤ªà¥‰à¤‡à¤‚à¤Ÿ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚" : "è¯·è¾“å…¥APIç«¯ç‚¹");

            // ç¿»è¯‘ç³»ç»Ÿæ¶ˆæ¯ï¼ˆä¸Šä¸‹æ–‡æ ‡ç­¾ï¼‰
            translateMessages(lang);
            showWelcomeMessage(lang);

            // Update language button icon
            const languageButton = document.getElementById('languageButton');
            if (languageButton) {
                if (lang === 'zh') languageButton.innerHTML = '<i class="fas fa-globe"></i>';
                if (lang === 'en') languageButton.innerHTML = '<i class="fas fa-language"></i>';
                if (lang === 'hi') languageButton.innerHTML = '<i class="fas fa-font"></i>';
            }
        }

        function showWelcomeMessage(lang) {
            const langData = translations[lang] || translations['zh'];

            // Fallback for conversation_start
            const contextText = langData.conversation_start ||
                (lang === 'en' ? 'Conversation Start' :
                 lang === 'hi' ? 'à¤µà¤¾à¤°à¥à¤¤à¤¾à¤²à¤¾à¤ª à¤¶à¥à¤°à¥‚' : 'å¯¹è¯å¼€å§‹');

            const welcomeHTML = `
            <div class="message flex items-start space-x-3">
                <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div class="message-bubble ai-message">
                    <div class="conversation-context" data-context-key="conversation_start">
                        <i class="fas fa-info-circle mr-1"></i>
                        ${contextText}
                    </div>
                    <div class="space-y-3">
                        <p class="font-semibold text-lg">${langData.welcome_title}</p>
                        <p class="text-gray-700">${langData.welcome_description}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-shopping-cart text-blue-500"></i>
                                <span>${langData.service1}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-image text-green-500"></i>
                                <span>${langData.service2}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-truck text-purple-500"></i>
                                <span>${langData.service3}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-headset text-orange-500"></i>
                                <span>${langData.service4}</span>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mt-3">${langData.welcome_footer}</p>
                    </div>
                </div>
            </div>
            `;
            document.getElementById('welcomeMessage').innerHTML = welcomeHTML;
        }

        function getLanguageName(lang) {
            switch(lang) {
                case 'zh': return 'ä¸­æ–‡';
                case 'en': return 'English';
                case 'hi': return 'à¤¹à¤¿à¤‚à¤¦à¥€';
                default: return 'æœªçŸ¥è¯­è¨€';
            }
        }

        // å¤„ç†è¡¨å•æäº¤
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await sendMessage();
        });

        // å¤„ç†å›è½¦é”®
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // å­—ç¬¦è®¡æ•°
        document.getElementById('messageInput').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('charCount').textContent = count;
            if (count > 450) {
                document.getElementById('charCount').classList.add('text-red-500');
            } else {
                document.getElementById('charCount').classList.remove('text-red-500');
            }
        });

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message && !selectedImage) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user', selectedImage);

            // ä¿å­˜åˆ°å¯¹è¯å†å²
            conversationHistory.push({
                role: 'user',
                content: message,
                image: selectedImage ? 'image_uploaded' : null,
                timestamp: new Date().toISOString()
            });

            // æ›´æ–°å¯¹è¯è®¡æ•°
            conversationCount++;
            document.getElementById('conversationCount').textContent = `å¯¹è¯è½®æ¬¡: ${conversationCount}`;

            // æ¸…ç©ºè¾“å…¥
            messageInput.value = '';
            document.getElementById('charCount').textContent = '0';
            const imageToSend = selectedImage;
            removeImage();

            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                // å‡†å¤‡è¡¨å•æ•°æ®
                const formData = new FormData();
                formData.append('message', message);
                if (imageToSend) {
                    formData.append('image', imageToSend, imageToSend.name);
                }
                formData.append('language', getCurrentLanguage());

                // å‘é€è¯·æ±‚
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                hideTypingIndicator();

                // æ·»åŠ AIå›å¤
                if (result.success) {
                    addMessage(result.answer, 'ai');

                    // ä¿å­˜AIå›å¤åˆ°å¯¹è¯å†å²
                    conversationHistory.push({
                        role: 'assistant',
                        content: result.answer,
                        timestamp: new Date().toISOString()
                    });

                    // å¦‚æœAPIè¿”å›äº†æ–°çš„è¯­è¨€è®¾ç½®ï¼Œæ›´æ–°é¡µé¢è¯­è¨€
                    if (result.lang && result.lang !== getCurrentLanguage()) {
                        setLanguage(result.lang);
                    }
                } else {
                    addMessage('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'ai');
                }

            } catch (error) {
                hideTypingIndicator();
                addMessage('ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'ai');
                console.error('Error:', error);
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸï¼ˆå®‰å…¨è®¿é—®ç¿»è¯‘é”®ï¼‰
        function addMessage(content, sender, image = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message flex items-start space-x-3';

            // å®‰å…¨è·å–å½“å‰è¯­è¨€åŠ©æ‰‹å›å¤æ–‡æœ¬
            const langData = translations[getCurrentLanguage()] || translations['zh'];
            const assistantReply = langData.assistant_reply || 'åŠ©æ‰‹å›å¤';

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex-1"></div>
                    <div class="message-bubble user-message">
                        ${image ? `<img src="${URL.createObjectURL(image)}" class="max-w-full h-auto rounded-lg mb-3 shadow-md" alt="ç”¨æˆ·å›¾ç‰‡">` : ''}
                        <p class="whitespace-pre-wrap">${content}</p>
                    </div>
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas fa-user text-white"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div class="message-bubble ai-message">
                        <div class="conversation-context" data-context-key="assistant_reply">
                            <i class="fas fa-robot mr-1"></i>
                            ${langData.assistant_reply || 'åŠ©æ‰‹å›å¤'}
                        </div>
                        <p class="whitespace-pre-wrap">${content}</p>
                    </div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.id = 'typingIndicator';
            indicator.className = 'message flex items-start space-x-3 typing-indicator show';
            indicator.innerHTML = `
                <div class="w-10 h-10 bg-gradient-to-r from-blue-400 to-purple-400 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div class="message-bubble ai-message">
                    <div class="flex space-x-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(indicator);
            scrollToBottom();
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage() {
            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];

            if (file) {
                selectedImage = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imageUploadArea').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage() {
            selectedImage = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imageUploadArea').classList.add('hidden');
        }

        // å¿«é€Ÿæé—®
        function askQuestion(questionKey) {
            const langData = translations[getCurrentLanguage()] || translations['zh'];
            const question = langData[questionKey];
            if (question) {
                document.getElementById('messageInput').value = question;
                sendMessage();
            } else {
                console.error(`Question key '${questionKey}' not found in language dictionary`);
            }
        }

        // æ¸…ç©ºèŠå¤©
        async function clearChat() {
            const langData = translations[getCurrentLanguage()] || translations['zh'];
            if (confirm(langData.clear_confirm)) {
                try {
                    // è°ƒç”¨åç«¯APIæ¸…ç©ºå¯¹è¯å†å²
                    const response = await fetch('/api/chat/clear', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('æ¸…ç©ºå¯¹è¯å†å²å¤±è´¥');
                    }

                    const result = await response.json();
                    console.log('æ¸…ç©ºå¯¹è¯å†å²ç»“æœ:', result);

                    // æ¸…ç©ºå‰ç«¯ç•Œé¢
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    // é‡ç½®å‰ç«¯å¯¹è¯å†å²
                    conversationHistory = [];
                    conversationCount = 0;
                    document.getElementById('conversationCount').textContent = langData.conversation_count + conversationCount;

                    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                    showWelcomeMessage(getCurrentLanguage());

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showNotification(langData.clear_success, 'success');

                } catch (error) {
                    console.error('æ¸…ç©ºå¯¹è¯å†å²å¤±è´¥:', error);
                    showNotification(langData.clear_fail, 'error');
                }
            }
        }

        // å¯¼å‡ºèŠå¤©è®°å½•
        function exportChat() {
            const langData = translations[getCurrentLanguage()] || translations['zh'];
            if (conversationHistory.length === 0) {
                alert(langData.no_export);
                return;
            }

            const chatText = conversationHistory.map(msg => {
                const time = new Date(msg.timestamp).toLocaleString();
                const role = msg.role === 'user' ? langData.user_role : langData.assistant_role;
                return `[${time}] ${role}: ${msg.content}`;
            }).join('\n\n');

            const blob = new Blob([chatText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${langData.app_title}_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;

            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            if (type === 'success') {
                notification.className += ' bg-green-500 text-white';
            } else if (type === 'error') {
                notification.className += ' bg-red-500 text-white';
            } else {
                notification.className += ' bg-blue-500 text-white';
            }

            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            const body = document.body;
            const icon = document.querySelector('.fa-moon, .fa-sun');

            // åˆ‡æ¢æ·±è‰²ä¸»é¢˜ç±»
            body.classList.toggle('dark');

            // åˆ‡æ¢å›¾æ ‡
            if (icon) {
                if (body.classList.contains('dark')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            }

            // ä¿å­˜ä¸»é¢˜åå¥½åˆ°æœ¬åœ°å­˜å‚¨
            const isDark = body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            // æ˜¾ç¤ºä¸»é¢˜åˆ‡æ¢é€šçŸ¥
            const themeName = isDark ? 'æ·±è‰²' : 'æµ…è‰²';
            showNotification(`å·²åˆ‡æ¢åˆ°${themeName}ä¸»é¢˜`, 'info');
        }

        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜åå¥½
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const icon = document.querySelector('.fa-moon, .fa-sun');

            if (savedTheme === 'dark') {
                body.classList.add('dark');
                if (icon) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                }
            }

            // è‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
            document.getElementById('messageInput').focus();

            // æ›´æ–°UIæ–‡æœ¬å¹¶æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            updateUIText(getCurrentLanguage());
            showWelcomeMessage(getCurrentLanguage());

            // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
            const quickQuestions = document.querySelectorAll('.quick-question');
            quickQuestions.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-3px) scale(1.02)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        });
    </script>
</body>
</html>